<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flappy Shlyapky</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        html, body { width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Courier New', monospace; }
        #gameCanvas { display: block; width: 100vw; height: 100vh; background: #171717; }
        #ui { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #fff; pointer-events: none; z-index: 10; width: 90%; }
        #startText, #gameOver { font-size: 42px; font-weight: bold; margin-bottom: 20px; }
        #scoreDisplay { font-size: 28px; margin-top: 20px; }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="ui">
        <div id="gameOver" style="display:none;">GAME OVER</div>
        <div id="startText">PRESS TO START</div>
        <div id="scoreDisplay"></div>
    </div>

    <script>
        setTimeout(() => {
  console.log("Проверка через 2 сек: Telegram.WebApp?", !!window.Telegram?.WebApp);
}, 2000);
        console.log("[GAME] Скрипт загружен");

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const bat = { x: canvas.width / 4, y: canvas.height / 2, width: 50, height: 40, velocity: 0, gravity: 0.5, jump: -10, flapDuration: 0 };
        const pipes = [];
        let score = 0;
        let gameStarted = false;
        let gameOver = false;
        let frameCount = 0;
        let pipeTimer = 90;

        const gameOverEl = document.getElementById('gameOver');
        const startTextEl = document.getElementById('startText');
        const scoreDisplay = document.getElementById('scoreDisplay');

        // Ждём полной готовности Telegram WebApp
        function onTelegramReady() {
            console.log("[GAME] Telegram.WebApp готов! Версия:", Telegram.WebApp.version || "неизвестна");
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }

        if (window.Telegram && Telegram.WebApp) {
            onTelegramReady();
        } else {
            document.addEventListener('TelegramWebAppReady', onTelegramReady);
            console.log("[GAME] Ожидание TelegramWebAppReady...");
        }

        function spawnPipe() {
            const gap = 160;
            const minHeight = 80;
            const maxHeight = canvas.height - gap - minHeight;
            const top = Math.random() * (maxHeight - minHeight) + minHeight;
            pipes.push({ x: canvas.width, top: top, bottom: top + gap, passed: false });
        }

        function updatePipes() {
            for (let i = pipes.length - 1; i >= 0; i--) {
                pipes[i].x -= 3;
                if (pipes[i].x + 80 < bat.x && !pipes[i].passed) {
                    pipes[i].passed = true;
                    score++;
                    scoreDisplay.textContent = `Score: ${score}`;
                }
                if (pipes[i].x < -100) pipes.splice(i, 1);
            }
            if (frameCount % 90 === 0 && gameStarted) spawnPipe();
        }

        function drawBat() {
            ctx.save();
            ctx.translate(bat.x, bat.y);
            if (bat.velocity > 2) ctx.rotate(0.5);
            if (bat.velocity < -2) ctx.rotate(-0.3);
            ctx.fillStyle = '#ff0';
            ctx.fillRect(-bat.width/2, -bat.height/2, bat.width, bat.height);
            ctx.fillStyle = '#fff';
            ctx.fillRect(-bat.width/2 + 10, -bat.height/2 + 10, 15, 15);
            ctx.restore();
        }

        function drawPipes() {
            ctx.fillStyle = '#0f0';
            pipes.forEach(pipe => {
                ctx.fillRect(pipe.x, 0, 80, pipe.top);
                ctx.fillRect(pipe.x, pipe.bottom, 80, canvas.height - pipe.bottom);
            });
        }

        function checkCollision() {
            if (bat.y - bat.height/2 < 0 || bat.y + bat.height/2 > canvas.height) return true;
            for (let pipe of pipes) {
                if (bat.x + bat.width/2 > pipe.x && bat.x - bat.width/2 < pipe.x + 80) {
                    if (bat.y - bat.height/2 < pipe.top || bat.y + bat.height/2 > pipe.bottom) return true;
                }
            }
            return false;
        }

        function jump() {
            if (!gameStarted) {
                gameStarted = true;
                startTextEl.style.display = 'none';
                score = 0;
                scoreDisplay.textContent = 'Score: 0';
                pipes.length = 0;
                pipeTimer = 90;
            } else if (gameOver) {
                bat.y = canvas.height / 2;
                bat.velocity = 0;
                pipes.length = 0;
                score = 0;
                gameOver = false;
                gameStarted = true;
                gameOverEl.style.display = 'none';
                startTextEl.style.display = 'none';
                scoreDisplay.textContent = 'Score: 0';
            } else {
                bat.velocity = bat.jump;
            }
        }

        function update() {
            if (!gameStarted || gameOver) return;
            bat.velocity += bat.gravity;
            bat.y += bat.velocity;
            updatePipes();
            if (checkCollision()) {
                gameOver = true;
                gameOverEl.style.display = 'block';
                startTextEl.innerHTML = 'PRESS TO START';
                startTextEl.style.display = 'block';

                console.log("[GAME] Игра окончена! Счёт:", score);

                if (window.Telegram && Telegram.WebApp) {
                    console.log("[GAME] Отправляю счёт боту:", score);
                    Telegram.WebApp.sendData(score.toString());
                    console.log("[GAME] sendData успешно вызван");
                } else {
                    console.log("[GAME] Telegram.WebApp недоступен — запуск не через бота?");
                }
            }
        }

        function draw() {
            ctx.fillStyle = '#171717';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            drawPipes();
            drawBat();
        }

        function gameLoop() {
            update();
            draw();
            frameCount++;
            requestAnimationFrame(gameLoop);
        }

        canvas.addEventListener('click', jump);
        canvas.addEventListener('touchstart', e => { e.preventDefault(); jump(); }, { passive: false });
        document.addEventListener('keydown', e => { if (e.code === 'Space') { e.preventDefault(); jump(); } });

        console.log("[GAME] Запуск игрового цикла...");
        gameLoop();
    </script>
</body>
</html>